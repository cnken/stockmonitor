/*! m_cart 2017-06-05 */
var csrf_token = $('meta[name="csrf-token"]').attr("content");
$(function(){
    if(cid>0)
        updateTotalPrice();
    if(is_weixin())
    {
        console.log("is_weixin");
        cartconfig.payment_type = 2;
        $("#hidpaymenttype").val(2);
    }

    $(".lazy").lazyload({
      threshold : 200
    });


    $(".quantity-decrease").on("click",function(){
        var coid = $(this).attr("data-coid");
        var num = $("#num"+coid).val();
        num = parseInt(num);
        if(num>0)
        {
            num -=1;
        }else{
            num = 0;
        }
        $("#num"+coid).val(num);
        updateTotalPrice();
    });

    $(".quantity-increase").on("click",function(){
        var coid = $(this).attr("data-coid");
        var goods = $("#goods"+coid);
        var count = goods.attr("data-count");
        var num = $("#num"+coid).val();
        num = parseInt(num);
        if(num<count)
        {
            num +=1;
        }else{
            layer.open({
              content: '超过最大购买数量了！',
              time: 2,
              skin: 'msg'
            });
            num = count;
        }
        $("#num"+coid).val(num);
        updateTotalPrice();
    });





    $("#payBtn").on("click",function()
    {
        var totalnum = $("#totalnum").text();
        totalnum = parseInt(totalnum);
        if(totalnum>0){
            $("#payBtn").attr("disabled","disabled");
            var toast = new auiToast();
            toast.loading({
                    title:"加载中",
                    duration:2000
                },function(ret){
                    //校验库存
                      var data = $("#cartform").serializeArray();
                      $.ajax({
                            cache: true,
                            type: "POST",
                            url:"/shopping/check",
                            data:$("#cartform").serializeArray(),
                            dataType:"json",
                            async: false,
                            error: function(request) {
                                alert("Connection error");
                            },
                            success: function(data) {
                                if(data.errno == 0){
                                    setTimeout(function(){
                                        toast.hide();  
                                        if(cartconfig.payment_type == 2){
                                            onBridgeReady(data.wxpayconfig,data.out_trade_no);
                                            toast.hide();
                                            $("#payBtn").removeAttr("disabled");
                                        }else{
                                            $("#payBtn").removeAttr("disabled");
                                            $("#cartform").submit();
                                        }
                                    },1000);
                                }
                                else{
                                    layer.open({
                                      content: '有部分商品库存不足，请重新选择！',
                                      time: 2,
                                      skin: 'msg'
                                    });
                                    window.location.reload();
                                }
                            }
                      });
            });
        }
        else{
            layer.open({
              content: '请选择商品',
              time: 2,
              skin: 'msg'
            });
        }
/*
      var data = $("#cartform").serializeArray();
      $.ajax({
            cache: true,
            type: "POST",
            url:"/pay/submit",
            data:$("#cartform").serializeArray(),
            async: false,
            error: function(request) {
                alert("Connection error");
            },
            success: function(data) {
                console.log(data);
            }
      });*/
    });
    getUser();
});
function updateTotalPrice()
{
    var totalprice = 0;
    var totalnum = 0;
    var goods_arr = $(".quantity");
    var savemoney = 0;
    for(var i=0;i<goods_arr.length;i++)
    {
        var t = goods_arr[i];
        t = $(t);
        var coid = t.attr("data-coid");
        var goods = $("#goods"+coid);
        var goods_price = parseFloat(goods.attr("data-price"));
        var goods_oprice = parseFloat(goods.attr("data-oprice"));
        var goods_num = parseInt(t.val());
        if(goods_num>0)
        {
            totalnum += goods_num;
            totalprice += goods_price*goods_num;
            if(goods_price<goods_oprice)
                savemoney += (goods_oprice-goods_price)*goods_num;
        }
    }
    totalprice = totalprice.toFixed(2);
    savemoney = savemoney.toFixed(2);
    $("#totalprice").text(totalprice);
    $("#totalnum").text(totalnum);
    $("#saveprice").text(savemoney);
    console.log("计算完成!");
}

function getUser()
{
    var access_token = localCache('access_token');
  $.ajax({
        cache: true,
        type: "POST",
        url:"/shopping/getuser",
        data:{'_csrf':csrf_token,'token':access_token},
        dataType:"json",
        async: false,
        error: function(request) {
            alert("Connection error");
        },
        success: function(response) {
            if(response.errno == 1 && response.token)
                localCache('access_token',response.token);
            if(response.token)
            {
                $("#hidtoken").val(response.token);
            }
        }
  });
}

function onBridgeReady(wxpayconfig,out_trade_no){
   WeixinJSBridge.invoke('getBrandWCPayRequest',wxpayconfig,function(res){     
           if(res.err_msg == "get_brand_wcpay_request:ok" ) {
                window.location.href = "/pay/return?out_trade_no="+out_trade_no;
           }     // 使用以上方式判断前端返回,微信团队郑重提示：res.err_msg将在用户支付成功后返回    ok，但并不保证它绝对可靠。 
       }
   ); 
}
